# Индивидуальное домашнее задание №3

## Выполнил: Натро Давид, БПИ216 (ФКН, ПИ, 2 курс)

### ~~Контакты~~

## Задача
Разработать программы на языках программирования C и Ассемблер, выполняющие вычисления над числами с плавающей точкой. Разработанные программы должны принимать числа в допустимом диапазоне. Например, нужно учитывать области определения и допустимых значений, если это связано с условием задачи.
> 1 вариант: Разработать программу, вычисляющую с помощью степенного ряда
с точностью не хуже 0,05% значение функции sqrt(1+x) параметра x.

# Инструкция к применению
## Запуск
Программа работает в 2х вариантах обработки входных данных:<br>

1) Файловый ввод/вывод.<br>
Для запуска пропишите команду:<br> ```./main.exe <input file> <output file>```,<br>где первым подаётся входной файл, а вторым выходной.<br>
2) Рандомный ввод и файловый вывод:<br>
Для запуска пропишите команду:<br>
```./main.exe -random <output file>```,<br>где output file - файл в который будет записан результат.

* В случае возникновения ошибки - будет выведено сообщение в консоль.
* По окончанию любого из вариантов работы программы замеры по времени будут выведены в консоль.

# Точность вычислений
* Входные данные читаются ДО 5 знаков после запятой!
  > Ни один из использумеых мной комьютеров не смог обеспечить более точные вычисления, после 5 знаков программа уходила в бесконечный цикл.
    Готов предоставить исходный код разных версий программы, где я пытался делать более точные вычисления, а так же доказательства ее неточности.
  
### Важно!
- Если программа завершилась с сообщением "Превышен лимит ожидания!", то это означает, что вычисления достигли бесконечности и не могут быть продолжены :(
  
Функция sqrt(x + 1) представляет собой биномиальный степенной ряд (x+1)^m, где m = 0.5.<br>
Данный ряд сходится на значениях -1 < x < 1, следовательно только значения из этого диапазона можно подавать на вход программе, иначе пропадает смысл и точность вычислений, так как ряд расходится и уходит в бесконечность.<br>
<br>
Требуется работа программы с точностью не хуже 0.05%.<br> 
Максимально допустимая погрешность - 0.00995 (0.05% от макисмального значения, которое равняется, округленно, 1.99)<br>
Следовательно допустимая погрешность на любых входных данных <= 0.00995. Данная программа обеспечивает требуемую точность.<br>

## Тестирование
Перейдя в папку [tests](tests/) и запустив скрипт [script.py](tests/script.py), написанный на питоне, результаты тестов будут выведены в консоль. Более подробно с тестированием Вы можете ознакомиться, прочитав файл [README.md](tests/README.md), который находится в той же папке.
# <br> Отчет
### Задание выполнено на 9 балов.<br>
Далее будет указан каждый выполнений пункт. Более подробные комментарии, где это требуется, можно будет увидеть, как в примере ниже, под соответствующим критерием.
* Некоторый критерий
    - более подробное описание.

#

### 4 бала
* Приведено решение задачи на C :white_check_mark:
  - Файлы: [main.c](main.c), [read.c](read.c), [print.c](print.c), [calculate.c](calculate.c)
* В полученную ассемблерную программу, откомпилированную без оптимизирующих и отладочных опций, добавлены комментарии, поясняющие эквивалентное представление переменных в программе на C. :white_check_mark:
  - К каждой переменной добавлен комментарий.
* Из ассемблерной программы убраны лишние макросы за счет использования соответствующих аргументов командной строки и/или за счет ручного редактирования исходного текста ассемблерной программы. :white_check_mark:
  - Комментарии в последнем критерии на 4 бала
* Модифицированная ассемблерная программа отдельно откомпилирована и скомпонована без использования опций отладки. :white_check_mark:
  - Комментарии в последнем критерии на 4 бала
* Представлено полное тестовое покрытие, дающее одинаковый результат на обоих программах. Приведены результаты тестовых прогонов для обоих программ, демонстрирующие эквивалентность функционирования. :white_check_mark:
  - В папке [tests](tests/) предоставлен скрипт [script.py](tests/script.py), который запускает тестирование и выводит его результат. Более подробно со скриптом можно ознакомиться прочитав файл [README.md](tests/README.md), который находится в той же папке tests. В той же папке имеется файл [report.txt](tests/report.txt), прочитав его, Вы можете ознакомиться с результатами тестовых прогонов. 
* Сформировать отчет, описывающий результаты тестовых прогонов и используемых опций компиляции и/или описания проведенных модификаций. :white_check_mark:
    - Обе программы проходят тестовое покрытие (отчет можно найти в папке [tests](tests/) или же убедиться лично, запустив скрипт [script.py](tests/script.py)). <br><br>
    Было оптимизировано большое количество кода
    заменой строчек вида:<br>
    lea reg1, reg2<br>
    mov reg3, reg1<br>
    на строчки вида:<br>
    lea reg3, reg2<br>
    Сравнения теперь происходят напрямую, без использования
    "вспомогательных" регистров. <br>
    Удалено большое количество nop. <br><br>
    Опции компиляции: Вы можете ознакомиться с командами, применяющимися для компиляции проекта в файле [build.py](build.py).
    Мной был написан скрипт на питоне, который позволил сэкономить много времени, благодаря автоматизации процесса компиляции. В данном скрипте вы увидите первые 3 команды, которые позволяли переводить C код в компактный ассемблер. После написаны 3 команды, которые переводили ассемблерные файлы в объектные. Последняя команда выполняла линковку, после чего удалялись все объектные файлы, происходил запуск программы и в консоль выводился результат её работы.


### 5 балов
* В реализованной программе необходимо использовать функции с передачей данных через параметры. :white_check_mark:
  - Реализованы функции read_data, print_data, calculate, в файлах [read.c](read.c), [print.c](print.c) и [calculate.c](calculate.c) соответсвенно, с передачей данных через параметры, а так же timespecDiff в файле [main.c](main.c)
* Использовать локальные переменные. :white_check_mark:
  - В функциях print_data, read_data, timepecDiff, calculate, factorial, numerator и main используются локальные переменные
* В ассемблерную программу при вызове функции добавить комментарии, описывающие передачу фактических параметров и перенос возвращаемого результата. :white_check_mark:
    - При вызове всех функций присутсвуют комментарии
* В функциях для формальных параметров добавить комментарии, описывающие связь между параметрами языка Си и регистрами (стеком). :white_check_mark:
* Добавить информацию о проведенных изменениях в отчет. :white_check_mark:

### 6 балов
* Рефакторинг программы на ассемблере за счет оптимизации использования регистров процессора. Или написание ассемблерной программы с нуля, используя собственное распределение регистров. :white_check_mark:
  - Были использованы регистры r12, r13, r14, r15, r12d, r13d, r14d, r15d, xmm0, xmm1.
* Добавление комментариев в разработанную программу, поясняющих эквивалентное использование регистров вместо переменных исходной программы на C. :white_check_mark:
  - Добавлены, где это требуется, коментарии. Так же в начале каждого ассемблерного файла Вы можете ознакомиться с рядом комментариев, которые описывают какие переменные хранит каждый из регистров 
* Представление результатов тестовых прогонов для разработанной программы. Оценка корректности ее выполнения на основе сравнения тестовых прогонов результатами тестирования программы, разработанной на языке C. :white_check_mark:
  - В папке [tests](tests/) предоставлен скрипт [script.py](tests/script.py), который запускает тестирование и выводит результат. Более подробно со скриптом можно ознакомиться прочитав файл [README.md](tests/README.md), который находится в той же папке tests. В той же папке имеется файл [report.txt](tests/report.txt), прочитав его, Вы можете ознакомиться с результатами тестовых прогонов. 
* Сопоставление размеров программы на ассемблере, полученной после компиляции с языка C с модифицированной программой, использующей регистры. :white_check_mark:
  - Собственная программа находится в корневой директории (там же где и этот readme), а программа, полученая после компиляции с языка C  [здесь](notOptimized/) (папка notOptimized, если не работает ссылка).

    > Размеры указываются в байтах

  | | Собственная программа | Программа после компиляции с языка С |
  | ------- | --------------------- | ------------------- |
  | main.s  |  7569                 |     5233            |
  | print.s |  1337                 |     1004            |
  | read.s  |  1634                 |     1168            |
  | calculate.s |    8304           |     4579            |
  | main.exe |       16544          |     16800           |
  
    - Собственная программа занимает больше памяти из-за комментариев.<br>
* Добавить новую информацию в отчет. :white_check_mark:

### 7 балов
* Реализация программы на ассемблере в виде двух или более единиц компиляции (программу на языке C разделять допускается, но не обязательно). :white_check_mark:
  - [main.c](main.c) [read.c](read.c) [print.c](print.c) [calculate.c](calculate.c) -> [main.s](main.s) [read.s](read.s) [print.s](print.s) [calculate.s](calculate.s)<br>
    Программа состоит из четырёх единиц компиляции.
* Использование файлов с исходными данными и файлов для вывода результатов. Имена файлов задаются с использованием аргументов командной строки. Командная строка проверяется на корректность числа аргументов и корректное открытие файлов. :white_check_mark:
  - Программа запускается командой ```./main.exe <input file> <output file>```,     где первым подаётся входной файл, а вторым выходной.
* Подготовка нескольких файлов, обеспечивающих тестовое покрытие разработанной программы. :white_check_mark:
  - В папке [tests](tests/) находятся 200 файлов с входными и 200 файлов с выходными данными. Более подробно Вы можете ознакомиться, прочитав файл [README.md](tests/README.md), который находится в той же [папке](tests/).
* Добавление в отчет информации о проведенном функциональном расширении, формате входных файлов, формате командной строки и результатах работы с тестовыми файлами. :white_check_mark:
  
### 8 балов

* Использование в разрабатываемых программах генератора случайных наборов данных, расширяющих возможности тестирования. :white_check_mark:
  - Запустив программу командой<br>```./main.exe -random <output file>```<br>будут сгенерированы рандомные данные и переданы программе, а так же выведены на экран. Результат будет выведен в output file.
* Изменение формата командной строки с учетом выбора ввода из файлов или с использованием генератора. :white_check_mark:
  - Программу можно запустить либо с файловым вводом/выводом: ```./main.exe <input file> <output file>```, либо с рандомным вводом и файловым выводом: ```./main.exe -random <output file>```. Более подробное описание в "Инструкции к применению" в начале этого файла.
* Включение в программы функций, обеспечивающих замеры времени для проведения сравнения на производительность. Необходимо добавить замеры во времени, которые не учитывают время ввода и вывода данных. Для увеличения времени работы минимум до 1 секунды, в зависимости от особенностей программы, можно либо выбирать соответствующие размеры исходных данных, либо зацикливать для многократного выполнения ту часть программы, которая выполняет вычисления. В последнем случае можно использовать соответствующую опцию командной строки, задающей количество повторений. :white_check_mark:
  - Программа замеряет время выполнения без учета ввода/вывода, независимо от формата (консольный или рандомный).
  Результат времени выполнения выводится в консоль.
* Представить полученные временные данные в отчете для разных вариантов тестовых прогонов (наряду с другими данными, полученные при выполнении ранее описанных требований). :white_check_mark:
  - Для всех тестовых данных было измерено время выполения программы. Вместе с результатами выполненного тестирования Вы можете ознакомиться с временем выполнения каждого отдельного теста в файле [report.txt](tests/report.txt), который находится в папке [tests](tests/), 
  а в папках [inputs](tests/inputs/)/[outputs](tests/outputs/) с самими входными/выходными данными.


### 9 балов

* Используя опции оптимизации по скорости, сформировать из программы на C исходный код ассемблере. Провести сравнительный анализ с ассемблерной программой без оптимизации по размеру ассемблерного кода, размеру исполняемого файла и производительности. Сопоставить эти программы с собственной программой, разработанной на ассемблере, в которой вместо переменных максимально возможно используются регистры. :white_check_mark:

	- ```gcc O3 {filename}.c -S -o {filename}.s```
    - [Оптимизированная по скорости программа](speedOptimized/)
    - [Неоптимизированная программа](notOptimized/)
    - Собственная программа находится в данной директории

        > Размеры указываются в байтах

    |             | Собственная | Speed Optimized | Not Optimized |
    | ---------   | ----------- | --------------- | ------------- |
    | main.s      | 7569        | 4338            | 5233          |
    | print.s     | 1337        | 818             | 1004          |
    | read.s      | 1634        | 992             | 1168          |
    | calculate.s | 8304        | 3659            | 4579          |
    | main.exe    | 16544       | 16832           | 16800         |
    | Среднее время выполнения | 10016ns | 9380ns | 12824ns       |

* Аналогично, используя опции оптимизации по размеру, сформировать код на ассемблере. Провести сравнительный анализ с неоптимизированной программой по размеру ассемблерного кода, размеру исполняемого файла и производительности. Сопоставить эти программы с собственной программой, разработанной на ассемблере, в которой вместо переменных максимально возможно используются регистры. :white_check_mark:
	
	```gcc -masm=intel -fno-asynchronous-unwind-tables -fno-jump-tables -fno-stack-protector -fno-exceptions -fcf-protection=none -Os {file name}.c -S -o 	{file name}.s```

    - [Оптимизированная по размеру программа](sizeOptimized/)
    - [Неоптимизированная программа](notOptimized/)
    - Собственная программа находится в данной директории
  
        > Размеры указываются в байтах
	
    |             | Собственная | Size Optimized | Not Optimized |
    | ---------   | ----------- | --------------- | ------------- |
    | main.s      | 7569        | 3293            | 5233          |
    | print.s     | 1337        | 527             | 1004          |
    | read.s      | 1634        | 504             | 1168          |
    | calculate.s | 8304        | 2688            | 4579          |
    | main.exe    | 16544       | 16704           | 16800         |
    | Среднее время выполнения | 10016ns | 12206ns | 12824ns       |

* Представить в отчете полученные результаты, дополнив данные, представленные в предыдущем по предыдующим требованиям. :white_check_mark:
